"use strict";(self.webpackChunkdocusauruns_ts=self.webpackChunkdocusauruns_ts||[]).push([[22113],{3905:(e,t,a)=>{a.d(t,{Zo:()=>c,kt:()=>k});var n=a(67294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):l(l({},t),e)),a},c=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),u=p(a),m=r,k=u["".concat(s,".").concat(m)]||u[m]||d[m]||i;return a?n.createElement(k,l(l({ref:t},c),{},{components:a})):n.createElement(k,l({ref:t},c))}));function k(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=a.length,l=new Array(i);l[0]=m;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o[u]="string"==typeof e?e:r,l[1]=o;for(var p=2;p<i;p++)l[p]=a[p];return n.createElement.apply(null,l)}return n.createElement.apply(null,a)}m.displayName="MDXCreateElement"},77715:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>m,frontMatter:()=>i,metadata:()=>o,toc:()=>p});var n=a(87462),r=(a(67294),a(3905));const i={},l="Writing Scripts",o={unversionedId:"api/cc/writingscript",id:"api/cc/writingscript",title:"Writing Scripts",description:"Overview",source:"@site/docs/api/3_cc/writingscript.md",sourceDirName:"api/3_cc",slug:"/api/cc/writingscript",permalink:"/braincloud-apiref/api/cc/writingscript",draft:!1,editUrl:"https://github.com/getbraincloud/braincloud-apiref/tree/main/docs/api/3_cc/writingscript.md",tags:[],version:"current",lastUpdatedBy:"jasonl",lastUpdatedAt:1672193365,formattedLastUpdatedAt:"Dec 28, 2022",frontMatter:{},sidebar:"apiSidebar",previous:{title:"GetPeerProfileSession",permalink:"/braincloud-apiref/api/cc/peerbridge/getpeerprofilesession"},next:{title:"Server to Server (S2S)",permalink:"/braincloud-apiref/api/s2s/"}},s={},p=[{value:"Overview",id:"overview",level:2},{value:"Runtime Architecture",id:"runtime-architecture",level:2},{value:"Basic Structure",id:"basic-structure",level:2},{value:"Parameters (Arguments)",id:"parameters-arguments",level:3},{value:"Inline Code",id:"inline-code",level:3},{value:"Results",id:"results",level:3},{value:"Try it!",id:"try-it",level:3},{value:"Functions",id:"functions",level:2},{value:"Calling APIs",id:"calling-apis",level:2},{value:"Including Shared Scripts ccsharedscripts",id:"including-shared-scripts-ccsharedscripts",level:2},{value:"Calling Other Scripts otherscripts",id:"calling-other-scripts-otherscripts",level:2},{value:"Script paths",id:"script-paths",level:2},{value:"Invoking via Client API invokeclientapi",id:"invoking-via-client-api-invokeclientapi",level:2},{value:"API Hooks",id:"api-hooks",level:2},{value:"Configuring API Hooks",id:"configuring-api-hooks",level:3},{value:"Pre-Hook Scripts",id:"pre-hook-scripts",level:3},{value:"Post-Hook Scripts",id:"post-hook-scripts",level:3},{value:"Post-Fail-Hook Scripts",id:"post-fail-hook-scripts",level:3},{value:"Matchmaking Filters",id:"matchmaking-filters",level:2},{value:"Configuring the filter",id:"configuring-the-filter",level:3},{value:"S2S Scripts",id:"s2s-scripts",level:2},{value:"Scheduled Scripts",id:"scheduled-scripts",level:2},{value:"WebHooks",id:"webhooks",level:2}],c=(u="DocCardList",function(e){return console.warn("Component "+u+" was not imported, exported, or provided by MDXProvider as global scope"),(0,r.kt)("div",e)});var u;const d={toc:p};function m(e){let{components:t,...a}=e;return(0,r.kt)("wrapper",(0,n.Z)({},d,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"writing-scripts"},"Writing Scripts"),(0,r.kt)("h2",{id:"overview"},"Overview"),(0,r.kt)("p",null,"brainCloud allows developers to write custom code (in JavaScript) that resides\non brainCloud's servers. These scripts can be triggered by:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Apps - via the ",(0,r.kt)("a",{parentName:"li",href:"/api/cc/writingscript#invoking-via-client-api-invokeclientapi"},"Client API")),(0,r.kt)("li",{parentName:"ul"},"Other Scripts - via ",(0,r.kt)("a",{parentName:"li",href:"/api/cc/writingscript#calling-other-scripts-otherscripts"},"Cloud Code")),(0,r.kt)("li",{parentName:"ul"},"Special Features - like ",(0,r.kt)("a",{parentName:"li",href:"/api/cc/writingscript#matchmaking-filters"},"Matchmaking")),(0,r.kt)("li",{parentName:"ul"},"Private Servers - via the ",(0,r.kt)("a",{parentName:"li",href:"/api/cc/writingscript#s2s-scripts"},"S2S API")),(0,r.kt)("li",{parentName:"ul"},"Public Services - via ",(0,r.kt)("a",{parentName:"li",href:"/api/cc/writingscript#webhooks"},"WebHooks")),(0,r.kt)("li",{parentName:"ul"},"Other API calls - via the ",(0,r.kt)("a",{parentName:"li",href:"/api/cc/writingscript#api-hooks"},"API Hook")," mechanism"),(0,r.kt)("li",{parentName:"ul"},"Time-based - via brainCloud's ",(0,r.kt)("a",{parentName:"li",href:"/api/cc/writingscript#scheduled-scripts"},"Scheduling Service"))),(0,r.kt)("p",null,"Cloud Code scripts can be created, edited, and tested from the ",(0,r.kt)("a",{parentName:"p",href:"https://portal.braincloudservers.com/admin/dashboard#/development/serverscripts-edit"},"Edit Scripts page"),"\nof the brainCloud portal."),(0,r.kt)("admonition",{type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"Pro-tip: Be sure to click on the Cloud Code tab (top-right) to view the examples in this section.")),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("p",{parentName:"admonition"},"After reviewing these sections, be sure to check out our ",(0,r.kt)("a",{parentName:"p",href:"/api/cc/bridge"},(0,r.kt)("b",null,"bridge"))," for step-by-step instructions on how to create your own scripts!")),(0,r.kt)("h2",{id:"runtime-architecture"},"Runtime Architecture"),(0,r.kt)("p",null,"brainCloud's Cloud Code service is implemented using an embedded ",(0,r.kt)("a",{parentName:"p",href:"https://developer.mozilla.org/en-US/docs/Mozilla/Projects/Rhino"},"Mozilla Rhino")," Javascript engine."),(0,r.kt)("p",null,"Communications with the brainCloud APIs is facilitated by a ",(0,r.kt)("a",{parentName:"p",href:"/api/cc/bridge"},(0,r.kt)("b",null,"bridge"))," object that is available from all scripts. The ",(0,r.kt)("inlineCode",{parentName:"p"},"bridge")," allows you to retrieve references to ",(0,r.kt)("em",{parentName:"p"},"service proxies")," that allow you to make API calls into brainCloud. These ",(0,r.kt)("em",{parentName:"p"},"service proxies")," are organized in alignment with brainCloud's API Modules."),(0,r.kt)("p",null,"The documentation and signatures of the available Cloud Code Callable APIs are found in this API Reference under the ",(0,r.kt)("strong",{parentName:"p"},"Cloud Code")," language tab."),(0,r.kt)("h2",{id:"basic-structure"},"Basic Structure"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"CalculateArea - A simple cloud code script")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cfscript"},"// First get our parameters\nvar width = data.width;\nvar height = data.height;\n\n// Calculate the area\nvar result = width * height;\n\n// Return the result\nresult;\n")),(0,r.kt)("p",null,"The simplest scripts are composed of the following elements:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Parameters - arguments passed to the scripts"),(0,r.kt)("li",{parentName:"ul"},"Inline code"),(0,r.kt)("li",{parentName:"ul"},"Returned results")),(0,r.kt)("h3",{id:"parameters-arguments"},"Parameters (Arguments)"),(0,r.kt)("p",null,"For most types of scripts, arguments are passed to a brainCloud script via a ",(0,r.kt)("inlineCode",{parentName:"p"},"data")," json object accessible from within the script."),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"For example:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"var width = data.width;\nvar height = data.height;\n")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"CalculateArea - example parameters")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "width": 5,\n    "height": 6\n}\n')),(0,r.kt)("h3",{id:"inline-code"},"Inline Code"),(0,r.kt)("p",null,"Since it is inherently a ",(0,r.kt)("em",{parentName:"p"},"script"),", your Cloud Code method doesn't need to have much structure."),(0,r.kt)("p",null,"Simply enter the statements to execute, one after another. No need for functions (unless you want them), a main() routine, etc."),(0,r.kt)("h3",{id:"results"},"Results"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"CalculateArea - expected results")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "status": 200,\n    "data": {\n        "response": 30,\n        "success": true\n    }\n}\n')),(0,r.kt)("p",null,"Speaking of ",(0,r.kt)("em",{parentName:"p"},'"not much structure"'),', Cloud Code scripts return results by simply "stating" the object to be returned by the Rhino engine.'),(0,r.kt)("p",null,"So while you are undoubtably used to ",(0,r.kt)("inlineCode",{parentName:"p"},"return"),"-ing values, and you will in Javascript functions ",(0,r.kt)("em",{parentName:"p"},"within")," the script, for the final exit of your script, you simply state the resulting object."),(0,r.kt)("p",null,"Note how the ",(0,r.kt)("inlineCode",{parentName:"p"},"CalculateArea")," script is returning its result."),(0,r.kt)("h3",{id:"try-it"},"Try it!"),(0,r.kt)("p",null,"As a test, try entering and running the ",(0,r.kt)("inlineCode",{parentName:"p"},"CalculateArea")," script:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Log into the ",(0,r.kt)("em",{parentName:"li"},"Design Portal")),(0,r.kt)("li",{parentName:"ul"},"Create or select an ",(0,r.kt)("em",{parentName:"li"},"App")," to test with"),(0,r.kt)("li",{parentName:"ul"},"Go to ",(0,r.kt)("strong",{parentName:"li"},"Design | Cloud Code | Scripts"),", and click the ",(0,r.kt)("strong",{parentName:"li"},"[Create Folder]")," option from the ",(0,r.kt)("strong",{parentName:"li"},"[Action]")," dropdown menu to create a folder (skip this step if you want to put new script in root or an existing folder)"),(0,r.kt)("li",{parentName:"ul"},"Click the folder you just created to get into it (or stay in root folder), then click the ",(0,r.kt)("strong",{parentName:"li"},"[Create Script]")," option from the ",(0,r.kt)("strong",{parentName:"li"},"[Action]")," dropdown menu to create a script"),(0,r.kt)("li",{parentName:"ul"},'Give the script a name (i.e. "CalculateArea")'),(0,r.kt)("li",{parentName:"ul"},"Set the test parameters similar to those in the example parameters shown"),(0,r.kt)("li",{parentName:"ul"},"Go to the ",(0,r.kt)("strong",{parentName:"li"},"Editor")," page, and copy and paste the script code"),(0,r.kt)("li",{parentName:"ul"},"Click ",(0,r.kt)("strong",{parentName:"li"},"[Save]"),", then go to the ",(0,r.kt)("strong",{parentName:"li"},"Run")," page"),(0,r.kt)("li",{parentName:"ul"},"Click ",(0,r.kt)("strong",{parentName:"li"},"[Quick Authenticate]")," to authenticate a user, and then ",(0,r.kt)("strong",{parentName:"li"},"[Run]")," to run your script")),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"Congratulations! You've written your first Cloud Code Script!")),(0,r.kt)("admonition",{type:"success"},(0,r.kt)("p",{parentName:"admonition"},"For further detail of creating a script be sure to check out our knowledge base article ",(0,r.kt)("a",{parentName:"p",href:"/api/cc/bridge"},(0,r.kt)("b",null,"bridge")))),(0,r.kt)("h2",{id:"functions"},"Functions"),(0,r.kt)("p",null,"Functions are as you would expect in Javascript, with the added limitation that they should be defined ",(0,r.kt)("em",{parentName:"p"},"before")," the inline portion of your script begins."),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"[This is because if the functions were below your inline code, the last object in your code would be your last function, and the Rhino engine doesn't know how to evaluate that in terms of returned results.]")),(0,r.kt)("p",null,"You can see how the ",(0,r.kt)("inlineCode",{parentName:"p"},"PostScores")," script calls the ",(0,r.kt)("inlineCode",{parentName:"p"},"postScore()")," function that is defined at the top."),(0,r.kt)("h2",{id:"calling-apis"},"Calling APIs"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"PostScores - Post to multiple leaderboards")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cfscript"},'// Note assumes that 3 leaderboards ("board1", "board2" and "board3")\n// have already been created. Go to Design | Leaderboards in the\n// Design Portal to set up.\n\nfunction postScore( service, leaderboardId, score )\n{\n    // Call the API to post the score to the specified leaderboard\n    var result = service.postScoreToLeaderboard( leaderboardId, score, null );\n\n    if (result.status == 200){\n        return 1;\n    } else {\n        return 0;\n    }\n}\n\n// Script begins ===========\n\nvar numPosted = 0;\nvar score1 = data.score1;\nvar score2 = data.score2;\nvar score3 = data.score3;\n\n// Retrieve the service proxy\nvar leaderboardService = bridge.getLeaderboardServiceProxy();\n\n// Post the scores to the 3 leaderboards\nnumPosted += postScore( leaderboardService, "board1", score1);\nnumPosted += postScore( leaderboardService, "board2", score2);\nnumPosted += postScore( leaderboardService, "board3", score3);\n\n// Return the total posted\nnumPosted;\n')),(0,r.kt)("p",null,"To call a brainCloud API from within a script, you must retrieve the appropriate service proxy from the ",(0,r.kt)("inlineCode",{parentName:"p"},"bridge"),". You then call the desired method on the proxy."),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"The code below retrieves the number of times a user has logged into the app:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"var playerStateService = bridge.getPlayerStateServiceProxy();\nvar numLogins = playerStateService.readUserState().data.loginCount;\n")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"PostScores - example parameters")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "score1": 100,\n    "score2": 200,\n    "score3": 300\n}\n')),(0,r.kt)("p",null,"The larger example on the right shows how you can easily create a script to perform multiple operations on the server."),(0,r.kt)("admonition",{type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"Pro-tip: Invoking a cloud code script costs 1 API count - but its first 3 API calls are free, and every call after that is just 1/2 API count.")),(0,r.kt)("admonition",{type:"success"},(0,r.kt)("p",{parentName:"admonition"},"Since the PostScores script only makes 3 calls (to post to the leaderboard), its total cost is 1.5 API. That's a big savings compared to making these 3 calls from the client directly -- and it performs better too!.")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"PostScores - expected results")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "status": 200,\n    "data": {\n        "response": 3,\n        "success": true\n    }\n}\n')),(0,r.kt)("h2",{id:"including-shared-scripts-ccsharedscripts"},"Including Shared Scripts ","[ccsharedscripts]"),(0,r.kt)("p",null,"brainCloud supports shared scripts, which means you can include another script\nwithin a script using the new ",(0,r.kt)("inlineCode",{parentName:"p"},"bridge.include()")," operation:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"bridge.include(\u201cpath/to/scriptname.ccjs\u201d) \n")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Script 1- ",(0,r.kt)("em",{parentName:"p"},"EntityTemplate")," script (the data storage script)")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cfscript"},'var entityTemplate_01 = (function() {\n  var goals = 0;\n  var assists = 0;\n  function addGloas(val) {\n    goals += val;\n    return goals;\n  }\n  function addAssists(val) {\n    assists += val;\n    return assists;\n  }\n  \n  return {\n    entityType: function() {\n      return "athletes";\n    },\n\n    dataJson: function(goals, assists) {\n      return {\n        "firstName": "Super",\n        "surName": "Star",\n        "position": "forward",\n        "goals": addGloas(goals),\n        "assists": addAssists(assists)\n      };\n    }\n  };\n})();\n...\n')),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Script 2- ",(0,r.kt)("em",{parentName:"p"},"CreateCustomEntity")," script (Executing entity create operation)")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cfscript"},'"use strict";\nbridge.include("path/to/EntityTemplate.ccjs");\n\nfunction main() {\n\n    var response = {};\n    \n    //get the entityType from *EntityTemplate* script\n    bridge.logDebug("check entityType value", entityTemplate_01.entityType());\n    \n    //get the dataJson from *EntityTemplate* script\n    bridge.logDebugJson("check dataJson value", entityTemplate_01.dataJson(3,6));\n    \n    var entityType = entityTemplate_01.entityType();\n    var dataJson = entityTemplate_01.dataJson(3,6);\n    var acl = {\n    "other": 1\n    };\n    var timeToLive = null;\n    var isOwned = false;\n    var customEntityProxy = bridge.getCustomEntityServiceProxy();\n\n    var postResult = customEntityProxy.createEntity(entityType, dataJson, acl, timeToLive, isOwned);\n    if (postResult.status == 200) {\n        // Success!\n    }\n    return response;\n}\n\nmain();\n')),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"Note:")," "),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"A script can import multiple scripts."),(0,r.kt)("li",{parentName:"ul"},"The scripts must all be present within the app\u2026 (i.e. no including scripts from other apps)"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"bridge.include()")," calls must come first in a script. The only lines allowed to be before ",(0,r.kt)("em",{parentName:"li"},"bridge.include()")," are blank lines, //comments, and/or the ",(0,r.kt)("em",{parentName:"li"},"\u201duse strict\u201d;")," directive"),(0,r.kt)("li",{parentName:"ul"},"The extension is ignored by the call - but we recommend you append .ccjs anyway \u2190 this may be helpful in the future (we have plans!) ")),(0,r.kt)("h2",{id:"calling-other-scripts-otherscripts"},"Calling Other Scripts ","[otherscripts]"),(0,r.kt)("p",null,"To invoke a script from within another script, simply call the ",(0,r.kt)("inlineCode",{parentName:"p"},"bridge.callScript()")," method, specifying the name and parameters for the script to call."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'var parameters = { "arg1": 5, "arg2": 10 };\nvar scriptResults = bridge.callScript( "anotherScript", parameters );\nif (scriptResults.status == 200 && scriptResults.data.success === true) {\n    // process scriptResults.data.response appropriately\n    // ...\n}\n')),(0,r.kt)("p",null,"For more advanced scenarios (i.e. scheduled scripts, etc.), call the appropriate ",(0,r.kt)("a",{parentName:"p",href:"/api/capi/script/runscript"},(0,r.kt)("code",null,(0,r.kt)("inlineCode",{parentName:"a"},"Script")," service"))," method, as you would any other API call."),(0,r.kt)("h2",{id:"script-paths"},"Script paths"),(0,r.kt)("p",null,"brainCloud now supports script folders, allowing developers to better organize their cloud code scripts."),(0,r.kt)("admonition",{type:"success"},(0,r.kt)("p",{parentName:"admonition"},"Pro-tip: Script paths provided to the ",(0,r.kt)("em",null,"bridge.include()")," and ",(0,r.kt)("em",null,"bridge.callScript()")," should be relative to the location of the calling script. This is ",(0,r.kt)("em",null,"different")," than the ScriptService APIs - where script paths are ",(0,r.kt)("em",null,"relative to the root folder"),".")),(0,r.kt)("h2",{id:"invoking-via-client-api-invokeclientapi"},"Invoking via Client API ","[invokeclientapi]"),(0,r.kt)("p",null,"You use the ",(0,r.kt)("a",{parentName:"p",href:"/api/capi/script"},"Script")," service to invoke a Cloud Code script from a client application."),(0,r.kt)("p",null,"For more information (and language-specific examples), refer to the ",(0,r.kt)("a",{parentName:"p",href:"/api/capi/script/runscript"},(0,r.kt)("code",null,"RunScript"))," and ",(0,r.kt)("a",{parentName:"p",href:"/api/capi/script/runparentscript"},(0,r.kt)("code",null,"RunParentScript"))," API methods."),(0,r.kt)("h2",{id:"api-hooks"},"API Hooks"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("strong",{parentName:"p"},"CreateContactPreHook")," - intercepts the creation of ",(0,r.kt)("strong",{parentName:"p"},"contacts"))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cfscript"},'\n// Declare the result object\nvar result = {};\nresult.status = 200;\n\n// Check to see if we\'re creating a contact\nif (data.message.entityType == "contact")\n{\n    // Clone the message passed in\n    result.messageOverride = JSON.parse(JSON.stringify(data.message));\n\n    // Modify the last name of the contact to be created\n    result.messageOverride.data.lastName = data.message.data.lastName + data.parms.suffix;\n\n}\n\n// Return the result;\nresult;\n')),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("strong",{parentName:"p"},"CreateContactPreHook")," - Test parameters for script editor")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "service": "Entity",\n    "operation": "CreateEntity",\n    "message": {\n        "entityType": "contact",\n        "acl": {\n            "other": 0\n        },\n        "data": {\n            "firstName": "Bruce",\n            "lastName": "Wayne"\n        }\n    },\n    "parms": {\n        "suffix": "o"\n    }\n}\n')),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("strong",{parentName:"p"},"CreateContactPreHook")," - parameters for API Hook Configuration")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "suffix": "o"\n}\n')),(0,r.kt)("p",null,"brainCloud allows you to modify the default behaviour of most API methods by configuring a Cloud Code script to run immediately before (",(0,r.kt)("em",{parentName:"p"},"pre"),") or after (",(0,r.kt)("em",{parentName:"p"},"post"),") the built-in API code."),(0,r.kt)("p",null,"brainCloud commons refers to these as ",(0,r.kt)("em",{parentName:"p"},"Pre-Hooks")," and ",(0,r.kt)("em",{parentName:"p"},"Post-Hooks"),"."),(0,r.kt)("p",null,'brainCloud also allows you to specify a "Post-Fail-Hook" that gets called in the event of an API processing exception. These are very similar to "Post-Hooks" except that is passes\nthe "errorData" to the script rather than "message".'),(0,r.kt)("h3",{id:"configuring-api-hooks"},"Configuring API Hooks"),(0,r.kt)("p",null,"API Hooks are configured in the Design Portal, from the ",(0,r.kt)("strong",{parentName:"p"},"Design | Cloud Code | API Hooks")," screen."),(0,r.kt)("p",null,"When configuring an API Hook you need to specify:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The ",(0,r.kt)("em",{parentName:"li"},"Service")," and ",(0,r.kt)("em",{parentName:"li"},"Operation")," to hook into"),(0,r.kt)("li",{parentName:"ul"},"The ",(0,r.kt)("em",{parentName:"li"},"Script")," to invoke"),(0,r.kt)("li",{parentName:"ul"},"Whether it is a ",(0,r.kt)("em",{parentName:"li"},"Pre")," (before), ",(0,r.kt)("em",{parentName:"li"},"Post")," (after) or ",(0,r.kt)("em",{parentName:"li"},"PostFail")," (after failure) scripts"),(0,r.kt)("li",{parentName:"ul"},"Any additional ",(0,r.kt)("em",{parentName:"li"},"Parameters")," that you'd like to send into the script at runtime (allows you to potentially configure the same script for use in different situations)")),(0,r.kt)("h3",{id:"pre-hook-scripts"},"Pre-Hook Scripts"),(0,r.kt)("p",null,"Pre-hook scripts are called ",(0,r.kt)("em",{parentName:"p"},"prior")," to executing the specified API method. Pre-Hook scripts can:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Do some pre-processing prior to the API call"),(0,r.kt)("li",{parentName:"ul"},"Modify the parameters being passed to the API"),(0,r.kt)("li",{parentName:"ul"},"Abort the call if required")),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"data")," object sent to a pre-hook script contains the following standard elements:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Data Element"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"service"),(0,r.kt)("td",{parentName:"tr",align:null},"the name of the brainCloud service")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"operation"),(0,r.kt)("td",{parentName:"tr",align:null},"the name of the brainCloud operation being invokes (related to, but not necessarily the same as, the method name)")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"message"),(0,r.kt)("td",{parentName:"tr",align:null},"the arguments sent to the API call that is being modified")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"parms"),(0,r.kt)("td",{parentName:"tr",align:null},"the static parameters defined as part of the hook configuration")))),(0,r.kt)("p",null,"Pre-hook scripts must return results in a specific format so that brainCloud can decide how/if to modify the behaviour of the API call."),(0,r.kt)("p",null,"The JSON map returned by the script may contain the following members:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Data Element"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"status"),(0,r.kt)("td",{parentName:"tr",align:null},"Return 200 to continue processing, anything else to abort and return that status to the client")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"reasonCode"),(0,r.kt)("td",{parentName:"tr",align:null},"Additional error info (numeric) returned if status != 200")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"errorMessage"),(0,r.kt)("td",{parentName:"tr",align:null},"Textual error info returned if status != 200")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"messageOverride"),(0,r.kt)("td",{parentName:"tr",align:null},"To override the parameters sent to the API call, return a messageOverride element with the replacement set of parameters")))),(0,r.kt)("h3",{id:"post-hook-scripts"},"Post-Hook Scripts"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("strong",{parentName:"p"},"ReadContactPostHook")," - adds a fullName field when returning contacts")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cfscript"},'var result = {};\n\n// If the entity being returned is a contact\nif (data.message.entityType == "contact") {\n\n    // Clone the data being returned\n    result.data = JSON.parse(JSON.stringify(data.message));\n\n    // Add a fullName field\n    result.data.data.fullName = result.data.data.firstName + " " + result.data.data.lastName;\n\n    // Set the status to success\n    result.status = 200;\n\n}\n\nresult;\n')),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"ReadContactPostHook - Example Test Parameters for script editor")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "service": "entity",\n    "operation": "READ",\n    "callingMessage": {\n        "service": "entity",\n        "operation": "READ",\n        "data": {\n            "entityId": "a186da71-18b5-410d-9afa-779d6610bddd"\n        }\n    },\n    "message": {\n        "entityId": "a186da71-18b5-410d-9afa-779d6610bddd",\n        "entityType": "contact",\n        "version": 1,\n        "data": {\n            "lastName": "Wayneo",\n            "firstName": "Bruce"\n        },\n        "acl": {\n            "other": 0\n        },\n        "createdAt": 1467259136127,\n        "updatedAt": 1467259136127\n    },\n    "parms": {}\n}\n')),(0,r.kt)("p",null,"Post-hook scripts are called after executing a particular API call. Post-hook scripts can do some post-processing of the API results, optionally modifying the data that is returned to the client."),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"data")," object sent to a post-hook script contains the following standard elements:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Data Element"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"service"),(0,r.kt)("td",{parentName:"tr",align:null},"the name of the brainCloud service")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"operation"),(0,r.kt)("td",{parentName:"tr",align:null},"the name of the brainCloud operation being invokes (related to, but not necessarily the same as, the method name)")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"callingMessage"),(0,r.kt)("td",{parentName:"tr",align:null},"the original parameters sent into the API call")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"message"),(0,r.kt)("td",{parentName:"tr",align:null},"the data results from the api call")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"parms"),(0,r.kt)("td",{parentName:"tr",align:null},"the static parameters defined as part of the hook configuration")))),(0,r.kt)("p",null,"The script can return ",(0,r.kt)("inlineCode",{parentName:"p"},"null")," to have no effect on the original return value. If not ",(0,r.kt)("inlineCode",{parentName:"p"},"null"),", the returned object may include the following parameters:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Data Element"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"status"),(0,r.kt)("td",{parentName:"tr",align:null},"Return 200 for ok, other for not")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"reasonCode"),(0,r.kt)("td",{parentName:"tr",align:null},"Additional error info (numeric) returned if status != 200")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"errorMessage"),(0,r.kt)("td",{parentName:"tr",align:null},"Textual error info returned if status != 200")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"data"),(0,r.kt)("td",{parentName:"tr",align:null},"Replacement results of the call")))),(0,r.kt)("h3",{id:"post-fail-hook-scripts"},"Post-Fail-Hook Scripts"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("strong",{parentName:"p"},"UpdateCreatePostFailHook")," - creates a record if the update fails due non-existing record")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cfscript"},"var result = {};\n\n// If the error is missing record\nif (data.errorData.reasonCode == 40332) {\n\n    // create the record\n    var entityProxy = bridge.getEntityServiceProxy();\n    var createResult = entityProxy.create(data.callingMessage.entityType, data.callingMessage.data, data.callingMessage.acl);\n\n    // provide the result of the create\n    result['status'] = createResult.status;\n    result['data'] = createResult.data;\n\n}\n\nresult;\n")),(0,r.kt)("p",null,"Post-fail-hook scripts are called after executing a particular API call and encountering a processing exception.\nPost-fail-hook scripts can do some post-processing of the API failure, optionally overriding the failure in the return to the client."),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"data")," object sent to a post-fail-hook script contains the following standard elements:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Data Element"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"service"),(0,r.kt)("td",{parentName:"tr",align:null},"the name of the brainCloud service")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"operation"),(0,r.kt)("td",{parentName:"tr",align:null},"the name of the brainCloud operation being invokes (related to, but not necessarily the same as, the method name)")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"callingMessage"),(0,r.kt)("td",{parentName:"tr",align:null},"the original parameters sent into the API call")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"errorData"),(0,r.kt)("td",{parentName:"tr",align:null},"the reasonCode and errorMessage of the processing exception")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"parms"),(0,r.kt)("td",{parentName:"tr",align:null},"the static parameters defined as part of the hook configuration")))),(0,r.kt)("p",null,"The script can return ",(0,r.kt)("inlineCode",{parentName:"p"},"null")," or any empty object to proceeed with the failure as is. If not ",(0,r.kt)("inlineCode",{parentName:"p"},"null"),", the returned object should include the following parameters:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Data Element"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"status"),(0,r.kt)("td",{parentName:"tr",align:null},"Return 200 for error override to success, other for replacement error")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"reasonCode"),(0,r.kt)("td",{parentName:"tr",align:null},"Replacement error info (numeric) returned if status != 200")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"errorMessage"),(0,r.kt)("td",{parentName:"tr",align:null},"Replacement error info returned if status != 200")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"data"),(0,r.kt)("td",{parentName:"tr",align:null},"Replacement results of the call if returning 200")))),(0,r.kt)("h2",{id:"matchmaking-filters"},"Matchmaking Filters"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Example matchmaking filter parameters.\nThe system identifies a potential match and passes in the candidate info.\nExtraParms are sent as a parameter to the ",(0,r.kt)("inlineCode",{parentName:"p"},"FindPlayersUsingFilter()")," method.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "matchCandidate": {\n        "playerId": "aProfileId",\n        "playerName": "John Smith",\n        "playerRating": 100,\n        "pictureUrl": null,\n        "summaryFriendData": {\n        }\n    },\n    "extraParms": {\n        "excludedPlayerIds": ["xxx", "yyy"]\n    }\n}\n')),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Example matchmaking script - filters out cheaters.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cfscript"},"\nvar thePlayer = data.matchCandidate.playerId;\nvar cheaters = data.extraParms.excludedPlayerIds;\nvar result = true;\n\nfor (var i = 0; i < cheaters.length; i++)\n{\n    if (cheaters[i] == thePlayer) {\n        result = false;\n        break;\n    }\n}\n\nresult;\n\n")),(0,r.kt)("p",null,"brainCloud allows you to use Cloud Code scripts to filter matchmaking candidates."),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"data")," object passed to matchmaking scripts contain the following elements:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Data Element"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"matchCandidate"),(0,r.kt)("td",{parentName:"tr",align:null},"Candidate object for the player being considered")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"extraParms"),(0,r.kt)("td",{parentName:"tr",align:null},"The jsonExtraParms parameter sent to FindPlayersUsingFilter()")))),(0,r.kt)("p",null,"The matchCandidate object contains the following:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Data Element"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"playerId"),(0,r.kt)("td",{parentName:"tr",align:null},"Profile id of the player being considered")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"playerName"),(0,r.kt)("td",{parentName:"tr",align:null},"Name of the player being considered")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"playerRating"),(0,r.kt)("td",{parentName:"tr",align:null},"The rating of this player, as assigned by the game")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"pictureUrl"),(0,r.kt)("td",{parentName:"tr",align:null},"A profile picture of the player, if available")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"summaryFriendData"),(0,r.kt)("td",{parentName:"tr",align:null},"The custom summary data assigned to the player by the game")))),(0,r.kt)("p",null,"The script should return ",(0,r.kt)("inlineCode",{parentName:"p"},"true")," if the candidate is acceptable, ",(0,r.kt)("inlineCode",{parentName:"p"},"false")," otherwise"),(0,r.kt)("h3",{id:"configuring-the-filter"},"Configuring the filter"),(0,r.kt)("p",null,"The filter is configured via the ",(0,r.kt)("strong",{parentName:"p"},"Design | Multiplayer | Matchmaking")," page of the portal."),(0,r.kt)("h2",{id:"s2s-scripts"},"S2S Scripts"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("strong",{parentName:"p"},"CreateTournamentS2S")," - Creates a tournament entity")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cfscript"},'var SYSTEM_USER = "3e1de451-3743-462b-8478-be4da44855cb";\n\n// Create a user session for the system user\nvar userSession = bridge.getSessionForProfile(SYSTEM_USER);\n\n// Use that session to gain access to the Client API\nvar globalEntityService = bridge.getGlobalEntityServiceProxy(userSession);\n\n\n// Create the tournament object\nglobalEntityService.createEntity(\n    "tournament",\n    0,\n    { "other": 1}, // Anyone can read it\n    data);\n\n// Return success!\ntrue;\n')),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("strong",{parentName:"p"},"CreateTournamentS2S")," - test parameters")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-JSON"},'{\n    "name": "Christmas Chaos",\n    "startDate": "2016-12-20",\n    "durationDays": 5,\n    "firstPrize": 1000,\n    "secondPrize": 500,\n    "thirdPrize": 100\n}\n')),(0,r.kt)("p",null,"Server-to-Server (S2S) Scripts are invoked not from the Client API, but rather from our Server-to-Server Interface. These scripts are intended to be called from custom (private) servers - and may be utilized for managing global datafill, content management, triggering engagement events, etc."),(0,r.kt)("p",null,"The biggest difference between an S2S Script and a regular Cloud Code script is the ",(0,r.kt)("strong",{parentName:"p"},"absense of a User Session")," at runtime."),(0,r.kt)("p",null,"Normally Cloud Code scripts are always run within the context of a user (client) session - and thus these scripts have full access to the ",(0,r.kt)("strong",{parentName:"p"},"Client API"),"."),(0,r.kt)("p",null,"S2S Scripts are invoked without authenticating an individual end-user, thus do not have a user session associated with them, and ",(0,r.kt)("strong",{parentName:"p"},"do not have access to the Client API methods")," -- by default."),(0,r.kt)("p",null,"This would seem a significant limitation - and it is - but luckily there is an easy work-around. S2S scripts are able to ",(0,r.kt)("strong",{parentName:"p"},"create")," a temporary ",(0,r.kt)("strong",{parentName:"p"},"user session")," for a specified profile id.  This profile id may be part of the parameters passed into the script, or may be a known ",(0,r.kt)("strong",{parentName:"p"},"system user profileId")," that has been created for the app."),(0,r.kt)("admonition",{type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"Describing how to call the S2S interface is outside-the-scope of this section, but will be coming soon.")),(0,r.kt)("h2",{id:"scheduled-scripts"},"Scheduled Scripts"),(0,r.kt)("p",null,"brainCloud includes a scheduling system that allows you to defer running a script until a later time. You can schedule scripts via the ",(0,r.kt)("a",{parentName:"p",href:"/api/capi/script/schedulerunscriptutc"},(0,r.kt)("code",null,"ScheduleRunScriptUTC()"))," and ",(0,r.kt)("a",{parentName:"p",href:"/api/capi/script/schedulerunscriptminutes"},(0,r.kt)("code",null,"ScheduleRunScriptMinutes()"))," API calls."),(0,r.kt)("p",null,"Scheduling a script adds a ",(0,r.kt)("em",{parentName:"p"},"job")," to the brainCloud ",(0,r.kt)("em",{parentName:"p"},"job queue"),". You can view the list of current jobs in the queue via the ",(0,r.kt)("strong",{parentName:"p"},"Monitoring | Global Monitoring | Job Queue")," page of the portal."),(0,r.kt)("admonition",{type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"Like S2S scripts, scheduled scripts do not have a user session associated with them. Use the same techniques described above to create one if necessary.")),(0,r.kt)("h2",{id:"webhooks"},"WebHooks"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("strong",{parentName:"p"},"WebHookPassThru")," - Handy script to log any webhook requests sent to it. Useful for confirming the format of the parameters being sent from an external system. ","[",(0,r.kt)("em",{parentName:"p"},"Click on")," ",(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("em",{parentName:"strong"},"Cloud Code"))," ",(0,r.kt)("em",{parentName:"p"},"(above) to view."),"]")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cfscript"},'// This script logs and returns whatever is sent to it\n// Useful for initially testing what is being sent to your webhook\n\n// Some services (like Facebook!) send parameters with periods in them.\n// MongoDB doesn\'t like those - so we need to substitute "_" for the periods\n// before logging them to the global entity.\nfunction safeMap(aMap)\n{\n    var newMap = {};\n    var newKey = "";\n\n    for (var key in aMap) {\n        newKey = key.replace(/\\./g,"_");\n        newMap[newKey] = aMap[key];\n    }\n\n    return newMap;\n\n}\n\n// Main script...\n\nvar response = {};\n\n// Profile id of the "system user" account - can be any user\nvar SYSTEM_USER = "df329257-56e3-46fe-b6fb-9baba75acc22";\n\n// A pre-allocated Global Entity to use for logging the request\n// (Create manually via the API Explorer - give it a type\n// of "WEBHOOK_REQUEST" so that you can find it easily)\nvar WEBHOOK_REQUEST = "8c1b36d3-3cf8-4977-a0a9-edee0afa83db";\n\n// Clone the request parameters\nvar webHookParms = JSON.parse(JSON.stringify(data));\n\n// Make the arguments and parameters mongoDB-safe\nwebHookParms.headers = safeMap(data.headers);\nwebHookParms.parameters = safeMap(data.parameters);\n\n// Get a user session\nvar userSession = bridge.getSessionForProfile(SYSTEM_USER);\n\n// Use it to access the Client API\nvar globalEntityService = bridge.getGlobalEntityServiceProxy(userSession);\n\n// Log the request to the global entity\nvar updateResult = globalEntityService.updateEntity(\n    WEBHOOK_REQUEST,   // We\'ve pre-allocated the entity\n    -1,                // Skip the version check\n    webHookParms);\n\n// Construct a response\nresponse.jsonResponse = {};\n\nif (updateResult.status != 200)\n{\n    response.jsonResponse.message = "Error writing request to global entity (" + WEBHOOK_REQUEST + ")";\n    response.jsonResponse.updateResult = updateResult;\n    response.jsonResponse.webHookParms = data;\n}\nelse\n{\n    response.jsonResponse.message = "Webhook received and recorded to global entity (" + WEBHOOK_REQUEST + ")";\n    response.jsonResponse.webHookParms = data;\n}\n\nresponse;\n')),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("strong",{parentName:"p"},"WebHookPassThru")," - Test parameters for the script editor")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "headers": {\n        "header1": "hello"\n    },\n    "stringBody": "value2",\n    "jsonBody": {\n        "aKey": "aValue"\n    },\n    "pathBalance": "aPath",\n    "parameters": {\n        "parm1": 1\n    },\n    "requestUrl": "url"\n}\n')),(0,r.kt)("p",null,"brainCloud also allows S2S-style Cloud Code scripts to be called via WebHooks."),(0,r.kt)("p",null,"WebHooks are defined and linked to Cloud Code scripts from the ",(0,r.kt)("strong",{parentName:"p"},"Design | Cloud Code | WebHooks")," page of the portal."),(0,r.kt)("p",null,"WebHook scripts receive a ",(0,r.kt)("inlineCode",{parentName:"p"},"data")," object with the following elements:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Data Element"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"headers"),(0,r.kt)("td",{parentName:"tr",align:null},"An object representing the HTTP headers in the WebHook call")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"stringBody"),(0,r.kt)("td",{parentName:"tr",align:null},"The body of the WebHook call if it is a non-json string")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"jsonBody"),(0,r.kt)("td",{parentName:"tr",align:null},"An object representing the body of the WebHook call")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"pathBalance"),(0,r.kt)("td",{parentName:"tr",align:null},"The balance of the path in the WebHook call, exclusive of the required url as specified in the portal config")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"parameters"),(0,r.kt)("td",{parentName:"tr",align:null},"An object representing the parameters passed in the WebHook call")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"queryString"),(0,r.kt)("td",{parentName:"tr",align:null},"An string representation of the parameter component of the request URL")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"requestUrl"),(0,r.kt)("td",{parentName:"tr",align:null},"The full request url")))),(0,r.kt)("p",null,"The script return object can be populated with optional fields that can modify the results sent to the caller:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Data Element"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"jsonResponse"),(0,r.kt)("td",{parentName:"tr",align:null},'An object which the WebHook handler will stringify and return as a body. Setting this field will default the response content type to "application/json".')),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"stringResponse"),(0,r.kt)("td",{parentName:"tr",align:null},"A string which will be returned as a body if a non-json body is required")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"statusOverride"),(0,r.kt)("td",{parentName:"tr",align:null},"A numeric value to override the normal 200 OK return of the WebHook handler")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"contentType"),(0,r.kt)("td",{parentName:"tr",align:null},"A string which will override the content-type of the response")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"responseHeaders"),(0,r.kt)("td",{parentName:"tr",align:null},"A json map that overrides the http response headers.")))),(0,r.kt)("admonition",{type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"When the WebHook has been configured to require a secret ",(0,r.kt)("strong",null,"header"),', a header named "x-bc-secret" must be included in the HTTP call from the caller site.')),(0,r.kt)(c,{mdxType:"DocCardList"}))}m.isMDXComponent=!0}}]);