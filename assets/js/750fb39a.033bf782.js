"use strict";(self.webpackChunkdocusauruns_ts=self.webpackChunkdocusauruns_ts||[]).push([[59675],{3905:(e,t,a)=>{a.d(t,{Zo:()=>p,kt:()=>y});var n=a(67294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var c=n.createContext({}),s=function(e){var t=n.useContext(c),a=t;return e&&(a="function"==typeof e?e(t):l(l({},t),e)),a},p=function(e){var t=s(e.components);return n.createElement(c.Provider,{value:t},e.children)},d="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},h=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,i=e.originalType,c=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),d=s(a),h=r,y=d["".concat(c,".").concat(h)]||d[h]||m[h]||i;return a?n.createElement(y,l(l({ref:t},p),{},{components:a})):n.createElement(y,l({ref:t},p))}));function y(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=a.length,l=new Array(i);l[0]=h;var o={};for(var c in t)hasOwnProperty.call(t,c)&&(o[c]=t[c]);o.originalType=e,o[d]="string"==typeof e?e:r,l[1]=o;for(var s=2;s<i;s++)l[s]=a[s];return n.createElement.apply(null,l)}return n.createElement.apply(null,a)}h.displayName="MDXCreateElement"},19512:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>c,contentTitle:()=>l,default:()=>d,frontMatter:()=>i,metadata:()=>o,toc:()=>s});var n=a(87462),r=(a(67294),a(3905));const i={title:"One Way Offline Example",date:"2016-09-02"},l=void 0,o={unversionedId:"learn/key-concepts/multiplayer/one-way-offline-multiplayer-example/index",id:"learn/key-concepts/multiplayer/one-way-offline-multiplayer-example/index",title:"One Way Offline Example",description:"This example describes an approach for implementing a Clash of Clans, Boom Beach, etc. type of game.",source:"@site/docs/learn/1_key-concepts/multiplayer/one-way-offline-multiplayer-example/index.md",sourceDirName:"learn/1_key-concepts/multiplayer/one-way-offline-multiplayer-example",slug:"/learn/key-concepts/multiplayer/one-way-offline-multiplayer-example/",permalink:"/braincloud-apiref/learn/key-concepts/multiplayer/one-way-offline-multiplayer-example/",draft:!1,editUrl:"https://github.com/getbraincloud/braincloud-apiref/tree/main/docs/learn/1_key-concepts/multiplayer/one-way-offline-multiplayer-example/index.md",tags:[],version:"current",lastUpdatedBy:"jasonl",lastUpdatedAt:1672679892,formattedLastUpdatedAt:"Jan 2, 2023",frontMatter:{title:"One Way Offline Example",date:"2016-09-02"},sidebar:"learnSidebar",previous:{title:"Lobbies",permalink:"/braincloud-apiref/learn/key-concepts/multiplayer/lobbies/"},next:{title:"Client Libraries",permalink:"/braincloud-apiref/learn/client-libraries"}},c={},s=[{value:"Shared Entity Data",id:"shared-entity-data",level:2},{value:"Match Lifecycle",id:"match-lifecycle",level:2}],p={toc:s};function d(e){let{components:t,...a}=e;return(0,r.kt)("wrapper",(0,n.Z)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"This example describes an approach for implementing a Clash of Clans, Boom Beach, etc. type of game.")),(0,r.kt)("p",null,"There are many ways to solve this functionality, but in the following example, the player creates ",(0,r.kt)("strong",{parentName:"p"},"Read\xa0Only")," User Entities to define their defense information. \xa0All player data manipulation is done on the server via Cloud Code. \xa0In this tutorial, we represent the entire map in just one entity, but the same theory would apply if you represented each defense ",(0,r.kt)("em",{parentName:"p"},"in a separate entity (which would definitely be more efficient for larger maps).")),(0,r.kt)("h2",{id:"shared-entity-data"},"Shared Entity Data"),(0,r.kt)("p",null,"The following is an example of the type of data that might be created and shared in a One Way match. \xa0It defines a grid of defenses set up beforehand by the defender that will be constructed for the attacking player to attempt to defeat. \xa0This data is created and managed via the ",(0,r.kt)("a",{parentName:"p",href:"/api/capi/entity"},"User Entity APIs"),"."),(0,r.kt)("p",null,"Note that this data has an ACL of Read-Only. \xa0This ensures that it cannot be edited by anyone except the owner of the data (in this case the defender). \xa0This is not necessary but recommended to increase the security of the data."),(0,r.kt)("p",null,"The example below is the data portion of the shared user entity."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'{\n\xa0 \xa0\xa0"grid": {\n\xa0 \xa0\xa0\xa0 \xa0\xa0"gridType": "field",\n\xa0 \xa0\xa0\xa0 \xa0\xa0"dimesionX": 14,\n\xa0 \xa0\xa0\xa0 \xa0\xa0"dimensionY": 10,\n\xa0 \xa0\xa0\xa0 \xa0\xa0"background": "image.png"\n\xa0 \xa0\xa0},\n\xa0 \xa0\xa0"defenses": [\n\xa0 \xa0\xa0\xa0 \xa0\xa0{\n\xa0 \xa0\xa0\xa0 \xa0\xa0\xa0 \xa0\xa0"type": "Turret",\n\xa0 \xa0\xa0\xa0 \xa0\xa0\xa0 \xa0\xa0"x": 3,\n\xa0 \xa0\xa0\xa0 \xa0\xa0\xa0 \xa0\xa0"y": 3,\n\xa0 \xa0\xa0\xa0 \xa0\xa0\xa0 \xa0\xa0"dmg": 3.5,\n\xa0 \xa0\xa0\xa0 \xa0\xa0\xa0 \xa0\xa0"hp": 100,\n\xa0 \xa0\xa0\xa0 \xa0\xa0\xa0 \xa0\xa0"state": "active"\n\xa0 \xa0\xa0\xa0 \xa0\xa0}, {\n\xa0 \xa0\xa0\xa0 \xa0\xa0\xa0 \xa0\xa0"type": "Catapult",\n\xa0 \xa0\xa0\xa0 \xa0\xa0\xa0 \xa0\xa0"x": 9,\n\xa0 \xa0\xa0\xa0 \xa0\xa0\xa0 \xa0\xa0"y": 9,\n\xa0 \xa0\xa0\xa0 \xa0\xa0\xa0 \xa0\xa0"dmg": 7,\n\xa0 \xa0\xa0\xa0 \xa0\xa0\xa0 \xa0\xa0"hp": 215,\n\xa0 \xa0\xa0\xa0 \xa0\xa0\xa0 \xa0\xa0"state": "active"\n\xa0 \xa0\xa0\xa0 \xa0\xa0}\n\xa0 \xa0\xa0]\n}\n')),(0,r.kt)("h2",{id:"match-lifecycle"},"Match Lifecycle"),(0,r.kt)("p",null,"To start a match all that is required is the target player's profileId\xa0to call ",(0,r.kt)("a",{parentName:"p",href:"/api/capi/onewaymatch/startmatch"},"StartMatch()"),"\xa0with."),(0,r.kt)("p",null,"All read-only and read-write data shared by the opponent will be returned within the \u201centities\u201d section of the StartMatch response. \xa0In this case, our example entity from above would be returned, so that the attacker can set up the defense that they are about to attack."),(0,r.kt)("p",null,"It is important at this time to store the\xa0",(0,r.kt)("inlineCode",{parentName:"p"},"playbackStreamId")," returned from ",(0,r.kt)("inlineCode",{parentName:"p"},"StartMatch")," as you will need it to add events as the attack occurs."),(0,r.kt)("p",null,"Here is an example response to StartMatch:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'{\n    "status": 200,\n    "data": {\n        "playbackStreamId": "56fa4fce-6df1-4c74-8b71-81bdc17166a3",\n        "initiatingPlayerId": "b67b2d73-1e8c-42e9-9be5-9c1879a48555",\n        "targetPlayerId": "0da5ad24-2341-42f8-acb5-57aa2dd4ae94",\n        "status": "STARTED",\n        "summary": {},\n        "initialSharedData": {\n            "entities": [\n                {\n                    "playerId": "0da5ad24-2341-42f8-acb5-57aa2dd4ae94",\n                    "gameId": "20484",\n                    "entityId": "017ad242-62c9-47d0-ad60-626cb649571b",\n                    "entityType": "defenseData",\n                    "version": 1,\n                    "data": {\n                        "grid": {\n                            "gridType": "field",\n                            "dimesionX": 14,\n                            "dimensionY": 10,\n                            "background": "image.png"\n                        },\n                        "defenses": [\n                            {\n                                "type": "Turret",\n                                "x": 3,\n                                "y": 3,\n                                "dmg": 3.5,\n                                "hp": 100,\n                                "state": "active"\n                            },\n                            {\n                                "type": "Catapult",\n                                "x": 9,\n                                "y": 9,\n                                "dmg": 7,\n                                "hp": 215,\n                                "state": "active"\n                            }\n                        ]\n                    },\n                    "acl": {\n                        "other": 1\n                    },\n                    "createdAt": 1472760716905,\n                    "updatedAt": 1472760716905\n                }\n            ],\n            "statistics": {}\n        },\n        "events": [],\n        "expiryTime": 1472761351046,\n        "createdAt": 1472760751058,\n        "updatedAt": 1472760751058\n    }\n}\n')),(0,r.kt)("p",null,"Now that the match has started its time to update the Playback Stream of the match with the events that occur while the attacker is playing. \xa0This is done via the ",(0,r.kt)("a",{parentName:"p",href:"/api/capi/playbackstream"},"Playback Stream APIs"),"."),(0,r.kt)("p",null,"Use the ",(0,r.kt)("a",{parentName:"p",href:"/api/capi/playbackstream/addevent"},"AddEvent()"),"\xa0API to save events like\xa0",(0,r.kt)("em",{parentName:"p"},"Initial Attackers"),", ",(0,r.kt)("em",{parentName:"p"},"Unit Attacked"),", ",(0,r.kt)("em",{parentName:"p"},"User Tapped"),", ",(0,r.kt)("em",{parentName:"p"},"Boost Used"),", ",(0,r.kt)("em",{parentName:"p"},"Match Complete"),", etc. \xa0Data for the event being added should go in ",(0,r.kt)("inlineCode",{parentName:"p"},"eventData"),",\xa0whereas\xa0the summary data should be\xa0used\xa0to store information about the completion of the attack, so that we can modify items in the cloud script on completion of the match."),(0,r.kt)("p",null,"Here is an example of an ",(0,r.kt)("inlineCode",{parentName:"p"},"AddEvent()")," call's summary data:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'{\n    "unitsDestroyedAtIndex": [\n        "entity1",\n        "entity2"\n    ],\n    "goldStolen": 100,\n    "ratingChange": 5\n}\n')),(0,r.kt)("p",null,"Once the attack is complete its time to finalize the match result with ",(0,r.kt)("a",{parentName:"p",href:"/api/capi/onewaymatch/completematch"},"CompleteMatch()"),". \xa0We will do this using a cloud code script to limit how much control the App has over sensitive data."),(0,r.kt)("p",null,"Since we were keeping our Playback Stream updated all we need to pass our Cloud Code script is the ",(0,r.kt)("inlineCode",{parentName:"p"},"playbackStreamId")," and it can retrieve all the data it needs."),(0,r.kt)("p",null,"Here is the example script:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'// data is the incoming json object\nsStreamId = data.streamId;      // string: match to Complete\n\n// active players services\noneWayMatchService = bridge.getOneWayMatchServiceProxy(); // grab the One way match service\nplaybackService = bridge.getPlaybackStreamServiceProxy(); // grab the playback stream service\nproductService = bridge.getProductServiceProxy();         // grab the product service\nmatchMakingService = bridge.getMatchMakingServiceProxy(); // grab the matchmaking service\n\n// get the match info\nmatchData = playbackService.ReadStream(sStreamId);      // read the stream data, to get the summary data\n\n// get the target player id, as well as create a bridge to create its target versions of its services\nsTargetPlayerId = matchData.targetPlayerId;     \ntargetSession = bridge.getSessionForProfile(sProfileId); \ntargetEntityService = bridge.getEntityServiceProxy(); \ntargetMatchMakingService = bridge.getMatchMakingServiceProxy(targetSession);\ntargetProductService = bridge.getProductServiceProxy(targetSession); \n\npSummaryData = matchData.data.summary;\naUnitsDestroyed = pSummaryData.unitsDestroyedAtIndex;\n\n// set the units to be destroyed, and update them\nfor (var i = 0; i < aUnitsDestroyed.Length; ++i) { \n    entToDestroy = targetEntityService.getEntity(aUnitsDestroyed[i]); \n    entToDestroy.hp = 0; entToDestroy.state = "destroyed"; \n    targetEntityService.updateEntity(entToDestroy.entityId, entToDestroy.entityType, \n    entToDestroy, entToDestroy.acl, entToDestroy.version + 1); \n} \n\n// steal and award the currency \niGoldStolen = pSummaryData.goldStolen; \ntargetProductService.consumeCurrency("gold", iGoldStolen); \nproductService.awardCurrency("gold", iGoldStolen); \n\n// update the player ratings \niRatingChange = pSummaryData.ratingChange; \nif (iRatingChange > 0)\n{\n    matchMakingService.incrementPlayerRating(iRatingChange);\n    targetMatchMakingService.decrementPlayerRating(iRatingChange);\n}\nelse\n{\n    matchMakingService.decrementPlayerRating(iRatingChange);\n    targetMatchMakingService.incrementPlayerRating(iRatingChange);\n}\n\noneWayMatchService.CompleteMatch(sStreamId);                       // complete the match\n\ntrue;\n')),(0,r.kt)("p",null,"Use the Playback Stream Service ReadStream() API in order to read all the events associated with a One Way Offline Multiplayer match. All events are returned in sequential order, thus you will be able to replay all the events that occurred in the match. These streams are accessible by all, if the client can get the ID of the Playback Stream, they will be able to replay it."),(0,r.kt)("p",null,"Now the one-way match is complete, and both users\u2019 information has been updated via cloud code. This helps prevent client-side manipulation or user's data."),(0,r.kt)("p",null,"For more information:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/api/capi/onewaymatch"},"One-Way Match API")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/api/capi/playbackstream"},"PlaybackStream API")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/api/capi/matchmaking"},"Matchmaking API"))))}d.isMDXComponent=!0}}]);